---
# ConfigMap con el script del sensor
apiVersion: v1
kind: ConfigMap
metadata:
  name: productor-script
  namespace: logistica-system
data:
  sensor.py: |
    #!/usr/bin/env python3
    import redis
    import json
    import random
    import time
    import os
    from datetime import datetime
    
    # Configuración desde variables de entorno
    REDIS_HOST = os.getenv('REDIS_HOST', 'redis-service')
    REDIS_PORT = int(os.getenv('REDIS_PORT', '6379'))
    REDIS_PASSWORD = os.getenv('REDIS_PASSWORD', '')
    SENSOR_ID = os.getenv('SENSOR_ID', 'rbt-01')
    INTERVAL = int(os.getenv('INTERVAL', '3'))
    
    print(f"Iniciando sensor {SENSOR_ID}...")
    print(f"Conectando a Redis en {REDIS_HOST}:{REDIS_PORT}")
    
    # Conectar a Redis con autenticación
    try:
        r = redis.Redis(
            host=REDIS_HOST,
            port=REDIS_PORT,
            password=REDIS_PASSWORD,
            decode_responses=True,
            socket_timeout=5,
            socket_connect_timeout=5
        )
        # Verificar conexión
        r.ping()
        print("✓ Conexión a Redis establecida correctamente")
    except Exception as e:
        print(f"✗ Error al conectar con Redis: {e}")
        time.sleep(5)
        exit(1)
    
    # Bucle infinito de generación de datos
    contador = 0
    while True:
        try:
            # Generar dato aleatorio
            valor = round(random.uniform(10.0, 100.0), 2)
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            
            # Crear el objeto JSON según el formato requerido
            dato = {
                "sensor_id": SENSOR_ID,
                "valor": valor,
                "timestamp": timestamp
            }
            
            # Convertir a JSON string
            dato_json = json.dumps(dato)
            
            # Guardar en Redis (usando una lista para mantener histórico)
            r.lpush('sensor:data', dato_json)
            
            # Limitar el tamaño de la lista a los últimos 1000 elementos
            r.ltrim('sensor:data', 0, 999)
            
            # También guardar como hash el último valor para acceso rápido
            r.hset('sensor:latest', SENSOR_ID, dato_json)
            
            contador += 1
            print(f"[{contador}] Dato enviado: {dato_json}")
            
            # Esperar el intervalo configurado
            time.sleep(INTERVAL)
            
        except redis.exceptions.ConnectionError as e:
            print(f"✗ Error de conexión con Redis: {e}")
            print("Reintentando en 5 segundos...")
            time.sleep(5)
            try:
                r = redis.Redis(
                    host=REDIS_HOST,
                    port=REDIS_PORT,
                    password=REDIS_PASSWORD,
                    decode_responses=True
                )
                r.ping()
                print("✓ Reconexión exitosa")
            except:
                pass
        except Exception as e:
            print(f"✗ Error inesperado: {e}")
            time.sleep(INTERVAL)

---
# Deployment del Productor (Sensor)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: productor
  namespace: logistica-system
  labels:
    app: productor
spec:
  replicas: 1
  selector:
    matchLabels:
      app: productor
  template:
    metadata:
      labels:
        app: productor
    spec:
      containers:
      - name: sensor
        image: python:3.11-alpine
        command: 
        - sh
        - -c
        - |
          echo "Instalando dependencias..."
          pip install --no-cache-dir redis
          echo "Ejecutando script del sensor..."
          python /app/sensor.py
        env:
        - name: REDIS_HOST
          value: "redis-service"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-credentials
              key: redis-password
        - name: SENSOR_ID
          value: "rbt-01"
        - name: INTERVAL
          value: "3"
        volumeMounts:
        - name: script
          mountPath: /app
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: script
        configMap:
          name: productor-script
          defaultMode: 0755
      restartPolicy: Always
